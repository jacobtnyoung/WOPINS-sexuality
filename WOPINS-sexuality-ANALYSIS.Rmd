---
title: "WOPINS Sexuality Analysis"
output: 
  html_document:
    df_print: paged
    theme: lumen
    highlight: haddock
    toc: yes
    toc_float: yes
    code_fold: show
    self_contained: true
---

<style>
body {
text-align: justify}
</style>

```{r, echo=FALSE}

# set the defaults for the codechunks
knitr::opts_chunk$set( 
  eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE 
  )

```

```{r setup}

# ----------
# Setup 

# Clear the workspace
rm( list = ls() )

# libraries
library( here ) # for calling local directory
library( dplyr ) # for working with the data
library( network ) # for creating the network object
library( sna ) # for working with the network
library( ergm ) # for erg models
library( pander ) # for tables
library( stargazer ) # for nice html tables

# run the script to create the networks with the attributes
source( here( "WOPINS-sexuality-BUILD.R" ) )


```

```{r define-friend-model}

# ----------
# ERGMs

# build function with formula for ergm
net.formula <- function( net, gwideg.val, gwesp.val, seed.num ){
  net.terms <- 
    ( net ~ edges 
      
      # structural terms
      + mutual 
      + twopath
      + gwidegree( gwideg.val, fixed=TRUE )
      + gwesp( gwesp.val, fixed = TRUE )
      
      # terms of interest
      + nodeifactor( "sex_minority" )
      + nodeofactor( "sex_minority" )
      + nodematch( "sex_minority" )
      + nodeifactor( "prismom" )
      + nodeofactor( "prismom" )
      + nodematch( "prismom" )
      + nodeicov( "sexacceptance_reverse" )
      + nodeocov( "sexacceptance_reverse" )
      + absdiff( "sexacceptance_reverse" )
      
      # controls
      + nodeicov( "lage" )
      + nodeocov( "lage" )
      + absdiff( "lage" )
      + nodeicov( "grade" )
      + nodeocov( "grade" )
      + absdiff( "grade" )
      + nodeifactor( "white" )
      + nodeofactor( "white" )
      + nodematch( "white" )
      + nodeicov( "unitdays100" )
      + nodeocov( "unitdays100" )
      + absdiff( "unitdays100" )
      + nodeifactor( "protestantbinary" )
      + nodeofactor( "protestantbinary" )
      + nodematch( "protestantbinary" )
      + nodeicov( "healthchangefrom3mopre" )
      + nodeocov( "healthchangefrom3mopre" )
      + absdiff( "healthchangefrom3mopre" )
      + nodeicov( "MentalPhysicalHealth" )
      + nodeocov( "MentalPhysicalHealth" )
      + absdiff( "MentalPhysicalHealth" )
    )
  
  net.fit <- ergm( net.terms, 
                   control = control.ergm(
                     seed        = seed.num,
                     MCMLE.maxit = 1000 ) )
  return( net.fit )
  
}

```

## Models of Friendship

```{r unit-2-f-model}

# estimate the model ----
u2.model <- net.formula( u2.net, gwideg.val = 1.50, gwesp.val = 0.75, seed.num = 601601 )

# run the model for unit 2
#summary( u2.model )

```

```{r unit-3-f-model}

# estimate the model ----
u3.model <- net.formula( u3.net, gwideg.val = 1.50, gwesp.val = 0.75, seed.num = 1234567 )

# run the model for unit 3
#summary( u3.model )

```

```{r f-table}

stargazer( u2.model, u3.model,
           title = "ERGMs for Friendship",
           dep.var.caption = "",
           dep.var.labels = "",
           column.labels = c( "Unit 2", "Unit 3" ),
           dep.var.labels.include = FALSE,
           coef= list( coef( u2.model ), coef( u3.model ) ),
           se= list( sqrt( diag( u2.model$covar ) ), sqrt( diag( u3.model$covar ) ) ),
           type = "html" )

```

### Interpretation

#### Unit 2

  + A positive `nodeofactor.sex_minority.1` term indicates that sexual minority women are more likely to send friendship ties
  
  + A negative `nodeofactor.prismom` term indicates that prison mom's are less likely to send a friendship tie

  + A positive `nodeocov.sexacceptance_reverse` term indicates that those who are more accepting of sexual orientation are more likely to send a friendship tie

<br>

#### Unit 3

No significant effects for the *sexual minority*, *prison mom*, or *acceptance of sexual orientation* variables.

<br>
<hr>
<br>

## Models of Power/Influence

```{r unit-2-p-model}

# build function with formula for ergm ----
net.formula2 <- function( net, gwideg.val, gwesp.val, seed.num ){
  net.terms <- 
    ( net ~ edges 
      
      # structural terms
      #+ mutual 
      + twopath
      + gwidegree( gwideg.val, fixed=TRUE )
      + gwesp( gwesp.val, fixed = TRUE )
      
      # terms of interest
      + nodeifactor( "sex_minority" )
      + nodeofactor( "sex_minority" )
      + nodematch( "sex_minority" )
      #+ nodeifactor( "prismom" )
      #+ nodeofactor( "prismom" )
      #+ nodematch( "prismom" )
      + nodeicov( "sexacceptance_reverse" )
      + nodeocov( "sexacceptance_reverse" )
      + absdiff( "sexacceptance_reverse" )
      
      # controls
      + nodeicov( "lage" )
      + nodeocov( "lage" )
      + absdiff( "lage" )
      + nodeicov( "grade" )
      + nodeocov( "grade" )
      + absdiff( "grade" )
      + nodeifactor( "white" )
      + nodeofactor( "white" )
      + nodematch( "white" )
      + nodeicov( "unitdays100" )
      + nodeocov( "unitdays100" )
      + absdiff( "unitdays100" )
      + nodeifactor( "protestantbinary" )
      + nodeofactor( "protestantbinary" )
      + nodematch( "protestantbinary" )
      + nodeicov( "healthchangefrom3mopre" )
      + nodeocov( "healthchangefrom3mopre" )
      + absdiff( "healthchangefrom3mopre" )
      + nodeicov( "MentalPhysicalHealth" )
      + nodeocov( "MentalPhysicalHealth" )
      + absdiff( "MentalPhysicalHealth" )
    )
  
  net.fit <- ergm( net.terms, 
                   control = control.ergm(
                     seed        = seed.num,
                     MCMLE.maxit = 1000 ) )
  return( net.fit )
  
}

# estimate the model ----
u2.p.model <- net.formula2( u2.p.net, gwideg.val = 1.50, gwesp.val = 0.75, seed.num = 1234567 )

# run the model for unit 2
#summary( u2.p.model )

stargazer( u2.p.model, 
           coef= list( coef( u2.p.model ) ),
           se= list( sqrt( diag( u2.p.model$covar ) ) ),
           type = "text" )

```

```{r unit-3-p-terms}

# build function with formula for ergm ----
net.formula3 <- function( net, gwideg.val, gwesp.val, seed.num ){
  net.terms <- 
    ( net ~ edges 
      
      # structural terms
      + mutual 
      + twopath
      + gwidegree( gwideg.val, fixed=TRUE )
      + gwesp( gwesp.val, fixed = TRUE )
      
      # terms of interest
      + nodeifactor( "sex_minority" )
      + nodeofactor( "sex_minority" )
      + nodematch( "sex_minority" )
      #+ nodeifactor( "prismom" )
      #+ nodeofactor( "prismom" )
      #+ nodematch( "prismom" )
      + nodeicov( "sexacceptance_reverse" )
      + nodeocov( "sexacceptance_reverse" )
      + absdiff( "sexacceptance_reverse" )
      
      # controls
      + nodeicov( "lage" )
      + nodeocov( "lage" )
      + absdiff( "lage" )
      + nodeicov( "grade" )
      + nodeocov( "grade" )
      + absdiff( "grade" )
      + nodeifactor( "white" )
      + nodeofactor( "white" )
      + nodematch( "white" )
      + nodeicov( "unitdays100" )
      + nodeocov( "unitdays100" )
      + absdiff( "unitdays100" )
      + nodeifactor( "protestantbinary" )
      + nodeofactor( "protestantbinary" )
      + nodematch( "protestantbinary" )
      + nodeicov( "healthchangefrom3mopre" )
      + nodeocov( "healthchangefrom3mopre" )
      + absdiff( "healthchangefrom3mopre" )
      + nodeicov( "MentalPhysicalHealth" )
      + nodeocov( "MentalPhysicalHealth" )
      + absdiff( "MentalPhysicalHealth" )
    )
  
  net.fit <- ergm( net.terms, 
                   control = control.ergm(
                     seed        = seed.num,
                     MCMLE.maxit = 1000 ) )
  return( net.fit )
  
}

```

```{r unit-3-p-model}

# estimate the model ----
u3.p.model <- net.formula3( u3.p.net, gwideg.val = 1.25, gwesp.val = 1.00, seed.num = 6016016 )

```

```{r p-table}

stargazer( u2.p.model, u3.p.model,
           title = "ERGMs for Power/Influence",
           dep.var.caption = "",
           dep.var.labels = "",
           column.labels = c( "Unit 2", "Unit 3" ),
           dep.var.labels.include = FALSE,
           coef= list( coef( u2.p.model ), coef( u3.p.model ) ),
           se= list( sqrt( diag( u2.p.model$covar ) ), sqrt( diag( u3.p.model$covar ) ) ),
           type = "html" )

```

### Interpretation

#### Unit 2

  + A negative `nodeicov.sexacceptance_reverse` term indicates that those who are more accepting of sexual orientation are less likely to receive power/influence ties; or, put differently: women who are less accepting of sexual orientation are more likely to receive power/influence ties.

##### Test Marginal Effect for Unit 2

```{r unit-2-p-model-ame-setup, eval=TRUE, echo=FALSE}

u2.p.model2 <- ergm( u2.p.net ~ edges 
      + twopath + gwidegree( 1.50, fixed=TRUE ) + gwesp( 0.75, fixed = TRUE )

      # terms of interest
      + nodeifactor( "sex_minority" )
      + nodeofactor( "sex_minority" )
      + nodematch( "sex_minority" )
      #+ nodeifactor( "prismom" )
      #+ nodeofactor( "prismom" )
      #+ nodematch( "prismom" )
      + nodeicov( "sexacceptance_reverse" )
      + nodeocov( "sexacceptance_reverse" )
      + absdiff( "sexacceptance_reverse" )
      
      # controls
      + nodeicov( "lage" )
      + nodeocov( "lage" )
      + absdiff( "lage" )
      + nodeicov( "grade" )
      + nodeocov( "grade" )
      + absdiff( "grade" )
      + nodeifactor( "white" )
      + nodeofactor( "white" )
      + nodematch( "white" )
      + nodeicov( "unitdays100" )
      + nodeocov( "unitdays100" )
      + absdiff( "unitdays100" )
      + nodeifactor( "protestantbinary" )
      + nodeofactor( "protestantbinary" )
      + nodematch( "protestantbinary" )
      + nodeicov( "healthchangefrom3mopre" )
      + nodeocov( "healthchangefrom3mopre" )
      + absdiff( "healthchangefrom3mopre" )
      + nodeicov( "MentalPhysicalHealth" )
      + nodeocov( "MentalPhysicalHealth" )
      + absdiff( "MentalPhysicalHealth" ) , 
      control = control.ergm( seed = 1234567, MCMLE.maxit = 1000 ) 
      )

```

```{r unit-2-p-model-marginal, echo=FALSE, results=TRUE}

library( ergMargins ) #devtools::install_github("sduxbury/ergMargins") 

accept.ame  <- ergm.AME( u2.p.model2, var1 = "nodeicov.sexacceptance_reverse" )

accept.ame

```

The average marginal effect of the `nodeicov.sexacceptance_reverse` term is `r round( accept.ame[1],4 )` with a *p*-value of `r round( accept.ame[4],4 )`.

<br>

#### Unit 3

  + A negative `absdiff.sexacceptance_reverse` term indicates that women who are more similar in terms of their attitudes of sexual orientation more likely to send power/influence ties to each other.

<br>
<hr>
<br>

### Pooled Model

```{r pooled-p-model}

# pooled model ----  
pooled.formula <- 
    ( u2.u3.p.pooled.net ~ edges 
      
      # structural terms
      + mutual
      + twopath
      + gwidegree( 0.75, fixed=TRUE )
      + gwesp( 1.25, fixed = TRUE )
      
      # terms of interest
      + nodeifactor( "sex_minority" )
      + nodeofactor( "sex_minority" )
      + nodematch( "sex_minority" )
      #+ nodeicov( "prismom" )
      #+ nodeocov( "prismom" )
      #+ nodematch( "prismom" )
      + nodeicov( "sexacceptance_reverse" )
      + nodeocov( "sexacceptance_reverse" )
      + absdiff( "sexacceptance_reverse" )
      
      # controls
      + nodeicov( "lage" )
      + nodeocov( "lage" )
      + absdiff( "lage" )
      + nodeicov( "grade" )
      + nodeocov( "grade" )
      + absdiff( "grade" )
      + nodeifactor( "white" )
      + nodeofactor( "white" )
      + nodematch( "white" )
      + nodeicov( "unitdays100" )
      + nodeocov( "unitdays100" )
      + absdiff( "unitdays100" )
      + nodeifactor( "protestantbinary" )
      + nodeofactor( "protestantbinary" )
      + nodematch( "protestantbinary" )
      + nodeicov( "healthchangefrom3mopre" )
      + nodeocov( "healthchangefrom3mopre" )
      + absdiff( "healthchangefrom3mopre" )
      + nodeicov( "MentalPhysicalHealth" )
      + nodeocov( "MentalPhysicalHealth" )
      + absdiff( "MentalPhysicalHealth" )
      
      # Terms to test
      + S(
        ~ nodeifactor( "sex_minority" ) 
        + nodeofactor( "sex_minority" ) 
        + nodematch( "sex_minority" )
        + nodeicov( "sexacceptance_reverse" ) 
        + nodeocov( "sexacceptance_reverse" ) 
        + absdiff( "sexacceptance_reverse" ),
        ~ ( block == 1 )
        )

)
  
set.seed( 601601 )
pooled.p.fit <- ergm( 
  pooled.formula, 
  constraints = ~ blocks( "block", levels2 = c( 2, 3 ) ) 
  )

summary( pooled.p.fit )

```

#### Interpretation

  + The negative coefficient for the `S((block==1))~nodeicov.sexacceptance_reverse` term indicates that women on the good behavior unit are more likely to receive power/influence ties if they have less accepting attitudes toward sex. This term is restricting the model to just that unit. This shows that there is a difference across these units in terms of this effect. 

<br>
<hr>
<br>

###### ***Last updated `r format(Sys.time(), '%d %B, %Y')`***